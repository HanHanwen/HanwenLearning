# 常见表

## 全量表

每天的所有的最新状态的数据



## 增量表

每天的新增数据



## 拉链表

维护历史状态，以及最新状态数据



## 流水表

对于表中的每一个修改都会记录，可以用于反映实际记录的变更



> 拉链表VS流水表

拉链表：通常是对账户信息的历史变动进行处理保留的结果，用于统计业务相关情况

流水表：每天的交易形成的历史，用于统计账户及客户的情况



# 拉链表适用情况及场景

## 适用情况

1.数据量大

2.表中的部分字段会被更新

3.需要查看某一个时间段或者时间点的历史快照信息

> 1）查看某一订单在历史某一个时间的状态
>
> 2）某一个用户在过去一段时间内的下单次数

4.更新的比例和频率不是很大

> 如果表中信息变化不大，则每一天都保留一份全量数据，对于存储来言是极大的浪费



## 优点

1.满足反应历史的数据状态

2.最大的节省存储资源





# 拉链表案例

## 举例

### 1.订单表结构

> 6.20日订单表数据

| order_id | createtime | modifiedtime | status   |
| -------- | ---------- | ------------ | -------- |
| 001      | 2012-06-20 | 2012-06-20   | 创建     |
| 002      | 2012-06-20 | 2012-06-20   | 创建     |
| 003      | 2012-06-20 | 2012-06-20   | 支付完成 |



> 6.21日订单表数据

| order_id | createtime | modifiedtime | status         |
| -------- | ---------- | ------------ | -------------- |
| 001      | 2012-06-20 | 2012-06-21   | ***支付完成*** |
| 002      | 2012-06-20 | 2012-06-20   | 创建           |
| 003      | 2012-06-20 | 2012-06-20   | 支付完成       |
| 004      | 2012-06-21 | 2012-06-21   | 创建           |
| 005      | 2012-06-21 | 2012-06-21   | 创建           |



> 6.22日订单表数据

| order_id | createtime | modifiedtime | status         |
| -------- | ---------- | ------------ | -------------- |
| 001      | 2012-06-20 | 2012-06-21   | 支付完成       |
| 002      | 2012-06-20 | 2012-06-20   | 创建           |
| 003      | 2012-06-20 | 2012-06-22   | ***已发货***   |
| 004      | 2012-06-21 | 2012-06-21   | 创建           |
| 005      | 2012-06-21 | 2012-06-22   | ***支付完成*** |
| 006      | 2012-06-22 | 2012-06-22   | 创建           |



### 2.为实现数据存储，常见方案

1.快照表：

> 1）仅保留一份全量数据，当前数据即为该记录的最终状态（此时数据与6.22日订单数据一致）
>
> 2）若要查看历史状态，则无法实现

| order_id | createtime | modifiedtime | status   |
| -------- | ---------- | ------------ | -------- |
| 001      | 2012-06-20 | 2012-06-21   | 支付完成 |
| 002      | 2012-06-20 | 2012-06-20   | 创建     |
| 003      | 2012-06-20 | 2012-06-22   | 已发货   |
| 004      | 2012-06-21 | 2012-06-21   | 创建     |
| 005      | 2012-06-21 | 2012-06-22   | 支付完成 |
| 006      | 2012-06-22 | 2012-06-22   | 创建     |



2.全量历史表：

> 1）每天都保留一份全量数据，则数据库中针对该表存在14条数据
>
> 2）存在大量重复数据
>
> 3）随着数据量的递增会出现大量的存储浪费

| key  | order_id | createtime | modifiedtime | status   |
| ---- | -------- | ---------- | ------------ | -------- |
| 1    | 001      | 2012-06-20 | 2012-06-20   | 创建     |
| 2    | 001      | 2012-06-20 | 2012-06-21   | 支付完成 |
| 3    | 001      | 2012-06-20 | 2012-06-21   | 支付完成 |
| 4    | 002      | 2012-06-20 | 2012-06-20   | 创建     |
| 5    | 002      | 2012-06-20 | 2012-06-20   | 创建     |
| 6    | 002      | 2012-06-20 | 2012-06-20   | 创建     |
| 7    | 003      | 2012-06-20 | 2012-06-20   | 支付完成 |
| 8    | 003      | 2012-06-20 | 2012-06-20   | 支付完成 |
| 9    | 003      | 2012-06-20 | 2012-06-22   | 已发货   |
| 10   | 004      | 2012-06-21 | 2012-06-21   | 创建     |
| 11   | 004      | 2012-06-21 | 2012-06-21   | 创建     |
| 12   | 005      | 2012-06-21 | 2012-06-21   | 创建     |
| 13   | 005      | 2012-06-21 | 2012-06-22   | 支付完成 |
| 14   | 006      | 2012-06-22 | 2012-06-22   | 创建     |





### 3.历史拉链表

| key  | order_id | createtime | modifiedtime | status   | ***start_time*** | ***end_time***   |
| ---- | -------- | ---------- | ------------ | -------- | ---------------- | ---------------- |
| 1    | 001      | 2012-06-20 | 2012-06-20   | 创建     | 2012-06-20       | 2012-06-20       |
| 2    | 001      | 2012-06-20 | 2012-06-21   | 支付完成 | 2012-06-21       | ***9999-12-31*** |
| 3    | 002      | 2012-06-20 | 2012-06-20   | 创建     | 2012-06-20       | ***9999-12-31*** |
| 4    | 003      | 2012-06-20 | 2012-06-20   | 支付完成 | 2012-06-20       | 2012-06-21       |
| 9    | 003      | 2012-06-20 | 2012-06-22   | 已发货   | 2012-06-22       | ***9999-12-31*** |
| 10   | 004      | 2012-06-21 | 2012-06-21   | 创建     | 2012-06-21       | ***9999-12-31*** |
| 11   | 005      | 2012-06-21 | 2012-06-21   | 创建     | 2012-06-21       | 2012-06-21       |
| 12   | 005      | 2012-06-22 | 2012-06-22   | 支付完成 | 2012-06-22       | ***9999-12-31*** |
| 13   | 006      | 2012-06-22 | 2012-06-22   | 支付完成 | 2012-06-20       | ***9999-12-31*** |



> 1）增加2个字段：start_time（表示该条记录的生命周期开始时间——**周期快照时的状态**），end_time（该条记录的生命周期结束时间）
>
> 2）end_time= ‘9999-12-31’ 表示该条记录目前处于有效状态



## 拉链表更新方案

### 1.假设

> 1）数仓中订单历史表刷新频率为1天，当天更新前一天的增量数据
>
> 2）若一个订单在一天内存在多个变化，只会记录最后一个状态的历史
>
> 3）订单状态：创建、支付、完成
>
> 4）创建时间、修改时间只取到天
>
> 5）若原系统无修改时间，需要有机制确保抽取到每天的增量数据

### 2.更新步骤

#### 1.全量初始化

1）第一步：抽取全量数据到ods（抽取开始）

| order_id | createtime | modifiedtime | status |
| -------- | ---------- | ------------ | ------ |
| 1        | 2015-08-18 | 2015-08-18   | 创建   |
| 2        | 2015-08-18 | 2015-08-18   | 创建   |
| 3        | 2015-08-19 | 2015-08-21   | 支付   |
| 4        | 2015-08-19 | 2015-08-21   | 完成   |
| 5        | 2015-08-19 | 2015-08-20   | 支付   |
| 6        | 2015-08-20 | 2015-08-20   | 创建   |
| 7        | 2015-08-20 | 2015-08-21   | 支付   |



2）从ods刷至dw

| order_id | createtime | modifiedtime | status | dw_start_date | dw_end_date |
| -------- | ---------- | ------------ | ------ | ------------- | ----------- |
| 1        | 2015-08-18 | 2015-08-18   | 创建   | 2015-08-18    | 9999-12-31  |
| 2        | 2015-08-18 | 2015-08-18   | 创建   | 2015-08-18    | 9999-12-31  |
| 3        | 2015-08-19 | 2015-08-21   | 支付   | 2015-08-19    | 9999-12-31  |
| 4        | 2015-08-19 | 2015-08-21   | 完成   | 2015-08-19    | 9999-12-31  |
| 5        | 2015-08-19 | 2015-08-20   | 支付   | 2015-08-19    | 9999-12-31  |
| 6        | 2015-08-20 | 2015-08-20   | 创建   | 2015-08-20    | 9999-12-31  |
| 7        | 2015-08-20 | 2015-08-21   | 支付   | 2015-08-20    | 9999-12-31  |



#### 2.增量抽取

> 1）每天，从源系统订单表中，将前一天的增量数据抽取到ods蹭的增量数据表
>
> 2）这里的增量需要通过订单表的创建时间和修改时间来确定
>
> 3）注意：在ods蹭按天分区的增量表，最好保留一段时间的数据，以备后续数据有问题需要回滚重做



#### 3.增量刷新历史数据

> 每天正常刷新前一天的增量数据到历史表

抽取过来数据

| order_id | createtime | modifiedtime | status |
| -------- | ---------- | ------------ | ------ |
| 3        | 2015-08-19 | 2015-08-21   | 支付   |
| 4        | 2015-08-19 | 2015-08-21   | 完成   |
| 7        | 2015-08-20 | 2015-08-21   | 支付   |
| 8        | 2015-08-21 | 2015-08-22   | 支付   |



与历史数据进行合并处理：

| order_id | createtime | modifiedtime | status | dw_start_date | dw_end_date      |
| -------- | ---------- | ------------ | ------ | ------------- | ---------------- |
| 1        | 2015-08-18 | 2015-08-18   | 创建   | 2015-08-18    | 9999-12-31       |
| 2        | 2015-08-18 | 2015-08-18   | 创建   | 2015-08-18    | 9999-12-31       |
| 3        | 2015-08-19 | 2015-08-21   | 支付   | 2015-08-19    | ***2015-08-20*** |
| 3        | 2015-08-19 | 2015-08-21   | 支付   | 2015-08-21    | 9999-12-31       |
| 4        | 2015-08-19 | 2015-08-21   | 完成   | 2015-08-19    | ***2015-08-20*** |
| 4        | 2015-08-19 | 2015-08-21   | 完成   | 2015-08-21    | 9999-12-31       |
| 5        | 2015-08-19 | 2015-08-20   | 支付   | 2015-08-19    | 9999-12-31       |
| 6        | 2015-08-20 | 2015-08-20   | 创建   | 2015-08-20    | 9999-12-31       |
| 7        | 2015-08-20 | 2015-08-21   | 支付   | 2015-08-20    | ***2015-08-20*** |
| 7        | 2015-08-20 | 2015-08-21   | 支付   | 2015-08-21    | 9999-12-31       |
| 8        | 2015-08-21 | 2015-08-21   | 创建   | 2015-08-21    | ***9999-12-31*** |